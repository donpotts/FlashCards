@page "/flashcards/{Id:long}"
@inject AppService AppService
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@inject HttpClient HttpClient
@inject AuthenticationStateProvider AuthenticationStateProvider
@attribute [Authorize]

<PageTitle>FlashCards</PageTitle>

<div class="mb-3">
    <MudText Typo="Typo.h3">Flash Cards</MudText>
</div>

<!-- Scoring Summary -->
@if (scoreSummary != null)
{
    <MudPaper Class="pa-4 mb-4" Elevation="2">
        <MudText Typo="Typo.h5">Your Score Summary</MudText>
        <MudText Typo="Typo.body1">Deck: @scoreSummary.DeckName</MudText>
        <MudText Typo="Typo.body1">User: @scoreSummary.UserName</MudText>
        <MudText Typo="Typo.body1">Correct: @scoreSummary.Correct</MudText>
        <MudText Typo="Typo.body1">Incorrect: @scoreSummary.Incorrect</MudText>
        <MudText Typo="Typo.body1">Percentage: @scoreSummary.Percentage.ToString("F1")%</MudText>
        <MudText Typo="Typo.body1">Grade: @scoreSummary.LetterGrade</MudText>
    </MudPaper>
}

<MudStack AlignItems="AlignItems.End" Class="mb-3">
    <MudButton Variant="Variant.Filled" StartIcon="@Icons.Material.Filled.AddCircleOutline" Color="Color.Primary" OnClick="@(e => OnAdd())">Add</MudButton>
</MudStack>

<!-- Begin cards -->
@if (FlashCardsResult != null)
{
    <MudText Class="mt-6 mb-3" Typo="Typo.h5">Cards</MudText>
    <MudGrid Class="mb-3">
        @foreach (var FlashCards in FlashCardsResult.Value ?? Enumerable.Empty<FlashCards>())
        {
            var thisFlashCards = FlashCards;
            <MudItem xs="12" sm="6" md="4" lg="3">
                @if (FlashCards.ShowQuestion)
                {
                    <Animate Animation="Animations.FlipUp" Duration="TimeSpan.FromSeconds(0.5)">
                        <MudCard Class="d-flex flex-column mud-height-full">
                            <MudCardContent>
                                <MudText Typo="Typo.h6" Class="mb-2">@FlashCards.FlashCardDecks?.Name</MudText>
                                <MudText Typo="Typo.h4" Style="width: 300px; height: 200px; overflow: auto;">@FlashCards.Question</MudText>
                                <MudButton Variant="Variant.Text" Color="Color.Primary" OnClick="@(e => ToggleProperty(FlashCards))">Show Answer</MudButton>
                            </MudCardContent>
                            <MudCardActions Class="mt-auto">
                                <MudButton Variant="Variant.Text" Color="Color.Primary" OnClick="@(e => OnEdit(thisFlashCards))">Edit</MudButton>
                                <MudButton Variant="Variant.Text" Color="Color.Primary" OnClick="@(e => OnDelete(thisFlashCards))">Delete</MudButton>
                            </MudCardActions>
                        </MudCard>
                    </Animate>
                }
                else
                {
                    <Animate Animation="Animations.FlipDown" Duration="TimeSpan.FromSeconds(0.5)">
                        <MudCard Class="d-flex flex-column mud-height-full">
                            <MudCardContent>
                                <MudText Typo="Typo.h6" Class="mb-2">@FlashCards.FlashCardDecks?.Name</MudText>
                                <MudText Typo="Typo.h6" Style="width: 300px; height: 200px; overflow: auto;">@FlashCards.Answer</MudText>
                                <MudButton Variant="Variant.Text" Color="Color.Primary" OnClick="@(e => ToggleProperty(FlashCards))">Show Question</MudButton>
                                <MudButton Variant="Variant.Text" Color="Color.Success" OnClick="@(e => SaveCorrect(FlashCards))">Correct</MudButton>
                                <MudButton Variant="Variant.Text" Color="Color.Error" OnClick="@(e => SaveInCorrect(FlashCards))">Wrong</MudButton>
                            </MudCardContent>
                            <MudCardActions Class="mt-auto">
                                <MudButton Variant="Variant.Text" Color="Color.Primary" OnClick="@(e => OnEdit(thisFlashCards))">Edit</MudButton>
                                <MudButton Variant="Variant.Text" Color="Color.Primary" OnClick="@(e => OnDelete(thisFlashCards))">Delete</MudButton>
                            </MudCardActions>
                        </MudCard>
                    </Animate>
                }
            </MudItem>
        }
    </MudGrid>

    <div class="d-flex align-center justify-center mb-3">
        <MudPagination Color="Color.Primary" Count="pageCount" Selected="selectedPage" SelectedChanged="OnSelectedChangedAsync" />
    </div>
}

<!-- End cards -->

@code {
    [Parameter]
    public long Id { get; set; } = default!;
    private FlashCardScoring record = new();
    private ApplicationUserDto? user;

    // Scoring summary model
    private ScoreSummary? scoreSummary;

    // Begin cards
    private const int PageSize = 10;
    private AppService.ODataResult<FlashCards>? FlashCardsResult;
    private int pageCount = 1;
    private int selectedPage = 1;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            user = await AppService.GetUserAsync();
        }
        catch (Exception ex)
        {
            Snackbar.Add(ex.Message, Severity.Error);
        }
        await ReloadDataAsync();
        await LoadScoreSummaryAsync();
    }

    private async Task OnSelectedChangedAsync(int selected)
    {
        selectedPage = selected;
        await ReloadDataAsync();
        await LoadScoreSummaryAsync();
    }

    private async Task ReloadDataAsync()
    {
        var skip = (selectedPage - 1) * PageSize;
        string filter = $"FlashCardDecks/Id eq {Id}";
        FlashCardsResult = await AppService.ListFlashCardsODataAsync(PageSize, skip, "", filter, count: true, "FlashCardDecks,FlashCardScoring");

        if (FlashCardsResult?.Count.HasValue ?? false)
        {
            pageCount = (int)Math.Ceiling((double)FlashCardsResult.Count.Value / PageSize);
        }
        else
        {
            pageCount = 1;
        }
        StateHasChanged();
    }
    // End cards

    // Load and calculate the user's score summary for this deck
    private async Task LoadScoreSummaryAsync()
    {
        if (user == null) return;

        string filter = $"UserId eq '{user.Id}' and FlashCards/FlashCardDecks/Id eq {Id}";
        var scoringResult = await AppService.ListFlashCardScoringODataAsync(null, null, null, filter, false, "FlashCards");
        var scoring = scoringResult?.Value?.ToList() ?? new List<FlashCardScoring>();

        int correct = scoring.Count(x => x.IsCorrect == true);
        int incorrect = scoring.Count(x => x.IsCorrect == false);
        int total = correct + incorrect;
        double pct = total > 0 ? (double)correct / total * 100 : 0;
        string grade = pct >= 90 ? "A" : pct >= 80 ? "B" : pct >= 70 ? "C" : pct >= 60 ? "D" : "F";

        // Fetch FlashCardDecks data separately
        var deck = await AppService.GetFlashCardDecksByIdAsync(Id);
        var deckName = deck?.Name ?? "Unknown Deck";

        // Retrieve username using AuthenticationStateProvider
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var userName = authState.User.Identity?.Name ?? "Unknown User";

        scoreSummary = new ScoreSummary
        {
            Correct = correct,
            Incorrect = incorrect,
            Percentage = pct,
            LetterGrade = grade,
            DeckName = deckName,
            UserName = userName
        };
    }

    private string GetAbsoluteUri(string uri)
    {
        if (!uri.StartsWith("/"))
        {
            return uri;
        }

        var baseUri = HttpClient.BaseAddress;

        if (baseUri == null)
        {
            throw new Exception("Unable to determine base address");
        }

        Uri absolute = new(baseUri, uri);

        return absolute.ToString();
    }

    private async void OnAdd()
    {
        DialogOptions dialogOptions = new() { FullWidth = true, CloseOnEscapeKey = true };

        var result = await DialogService.Show<AddFlashCards>("Add FlashCards", dialogOptions).Result;

        if (!result.Canceled)
        {
            await ReloadDataAsync();
            await LoadScoreSummaryAsync();
        }
    }

    private async void OnEdit(FlashCards record)
    {
        DialogParameters<UpdateFlashCards> dialogParams = new() { { x => x.Id, record.Id!.Value } };
        DialogOptions dialogOptions = new() { FullWidth = true, CloseOnEscapeKey = true };

        var result = await DialogService.Show<UpdateFlashCards>("Update FlashCards", dialogParams, dialogOptions).Result;

        if (!result.Canceled)
        {
            await ReloadDataAsync();
            await LoadScoreSummaryAsync();
        }
    }

    private async void OnDelete(FlashCards record)
    {
        var result = await DialogService.ShowMessageBox(
            "Warning",
            "Are you sure you want to delete this record?",
            "Delete",
            "Cancel");

        if (result.GetValueOrDefault(false))
        {
            try
            {
                await AppService.DeleteFlashCardsAsync(record.Id!.Value);
                await ReloadDataAsync();
                await LoadScoreSummaryAsync();
            }
            catch (Exception ex)
            {
                Snackbar.Add(ex.Message, Severity.Error);
            }
        }
    }

    private async void ToggleProperty(FlashCards flashCard)
    {
        flashCard.ShowQuestion = !flashCard.ShowQuestion;
    }

    private async void SaveCorrect(FlashCards flashCard)
    {
        flashCard.ShowQuestion = true;
        try
        {
            record.AttemptDate = DateTime.Now;
            record.FlashCardsId = flashCard.Id;
            record.IsCorrect = true;
            record.UserId = user?.Id;
            await AppService.InsertFlashCardScoringAsync(record);
            await LoadScoreSummaryAsync();
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Snackbar.Add(ex.Message, Severity.Error);
        }
    }

    private async void SaveInCorrect(FlashCards flashCard)
    {
        flashCard.ShowQuestion = true;
        try
        {
            record.AttemptDate = DateTime.Now;
            record.FlashCardsId = flashCard.Id;
            record.IsCorrect = false;
            record.UserId = user?.Id;
            await AppService.InsertFlashCardScoringAsync(record);
            await LoadScoreSummaryAsync();
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Snackbar.Add(ex.Message, Severity.Error);
        }
    }

    // Helper class for score summary
    private class ScoreSummary
    {
        public int Correct { get; set; }
        public int Incorrect { get; set; }
        public double Percentage { get; set; }
        public string LetterGrade { get; set; } = string.Empty;
        public string DeckName { get; set; } = string.Empty;
        public string UserName { get; set; } = string.Empty;
    }
}
